# =======================
# 1. SQL Query Export
# =======================
$SQLServer = "FBRDATA"
$Database = "MIMDISTN"
$Query = @"
SELECT 
    RPT_RTPSequence_AuditReport.Plant, 
    RPT_RTPSequence_AuditReport.SeqNum, 
    RPT_RTPSequence_AuditReport.ProdNo, 
    RPT_RTPSequence_AuditReport.RTx, 
    RPT_RTPSequence_AuditReport.WIPBin, 
    RPT_RTPSequence_AuditReport.LineAsn AS LineAsn_Audit, 
    RPT_RTPSequence_AuditReport.SkuCude, 
    RPT_RTPSequence_AuditReport.AdjPlanQty, 
    RPT_RTPSequence_AuditReport.PlanQtyRT, 
    RPT_RTPSequence_AuditReport.SFC, 
    RPT_RTP_U_OpenMORQty.OrdQty, 
    RPT_RTP_U_OpenMORQty.ShipQty, 
    NLK_ProduceHeaderShort.PartNum, 
    NLK_ProduceHeaderShort.LineAsn AS LineAsn_Header, 
    RPT_RTP_U_MIMStk.QtyOnHand
FROM MIMDISTN.dbo.RPT_RTPSequence_AuditReport
INNER JOIN MIMDISTN.dbo.NLK_ProduceHeaderShort 
    ON RPT_RTPSequence_AuditReport.ProdNo = NLK_ProduceHeaderShort.ProdNo
LEFT OUTER JOIN MIMDISTN.dbo.RPT_RTP_U_OpenMORQty 
    ON RPT_RTPSequence_AuditReport.Plant = RPT_RTP_U_OpenMORQty.PO_Plant
    AND RPT_RTPSequence_AuditReport.SkuCude = RPT_RTP_U_OpenMORQty.PO_BasePartNum
LEFT OUTER JOIN MIMDISTN.dbo.RPT_RTP_U_MIMStk 
    ON RPT_RTPSequence_AuditReport.Plant = RPT_RTP_U_MIMStk.Plant
    AND RPT_RTPSequence_AuditReport.SkuCude = RPT_RTP_U_MIMStk.BasePartNum
WHERE RPT_RTPSequence_AuditReport.Plant = 'FB'
"@

$CSVExportPath = "C:\GDriveAPI\CSVExports\AuditReport.csv"

if (-not (Test-Path "C:\GDriveAPI\CSVExports")) {
    New-Item -ItemType Directory -Force -Path "C:\GDriveAPI\CSVExports"
}

# Execute SQL query with error handling
try {
    $results = Invoke-Sqlcmd -ServerInstance $SQLServer -Database $Database -Query $Query -EncryptConnection -TrustServerCertificate
    if ($results.Count -gt 0) {
        $results | Export-Csv -Path $CSVExportPath -NoTypeInformation -Encoding UTF8
        Write-Host "✅ SQL data exported to $CSVExportPath"
    } else {
        Write-Warning "⚠️ SQL query returned no results. Skipping upload."
        return
    }
} catch {
    Write-Error "❌ SQL query failed: $_"
    return
}

# =======================
# 2. Upload to Google Drive (overwrite)
# =======================
# Load Google API DLLs
$basePath = "C:\Program Files\PackageManagement\NuGet\Packages"
$driveDll = Get-ChildItem -Path "$basePath\Google.Apis.Drive.v3*" -Recurse -Filter "Google.Apis.Drive.v3.dll" | Select-Object -First 1 -ExpandProperty FullName
$authDll  = Get-ChildItem -Path "$basePath\Google.Apis.Auth*" -Recurse -Filter "Google.Apis.Auth.dll" | Select-Object -First 1 -ExpandProperty FullName
$coreDll  = Get-ChildItem -Path "$basePath\Google.Apis.Core*" -Recurse -Filter "Google.Apis.Core.dll" | Select-Object -First 1 -ExpandProperty FullName

Add-Type -Path $driveDll
Add-Type -Path $authDll
Add-Type -Path $coreDll

$GoogleCredential = [Google.Apis.Auth.OAuth2.GoogleCredential]
$DriveService = [Google.Apis.Drive.v3.DriveService]
$BaseClientService = [Google.Apis.Services.BaseClientService]

$serviceAccountKeyFile = "C:\GDriveAPI\Token\driveapi-fbrdata.json"
$scopes = @("https://www.googleapis.com/auth/drive")

$credential = $GoogleCredential::FromFile($serviceAccountKeyFile).CreateScoped($scopes)

$service = New-Object $DriveService(
    (New-Object $BaseClientService+Initializer -Property @{
        HttpClientInitializer = $credential
        ApplicationName = "Drive API PowerShell Upload"
    })
)

$folderId = "1iMG5R9Sq5cZk3i22rKjHOYsKauyTVHwJ"
$fileName = "AuditReport.csv"

# Check if the file already exists in Drive
$existingFile = $service.Files.List()
$existingFile.Q = "'$folderId' in parents and name = '$fileName' and trashed = false"
$existingFile.Fields = "files(id, name)"
$existingFiles = $existingFile.Execute().Files

if ($existingFiles.Count -gt 0) {
    # Overwrite existing file
    $fileId = $existingFiles[0].Id
    $fileStream = [System.IO.File]::Open($CSVExportPath, 'Open')
    $updateRequest = $service.Files.Update($null, $fileId, $fileStream, "text/csv")
    $updateRequest.Fields = "id"
    $updateRequest.Upload()
    $fileStream.Close()
    Write-Host "♻️ Existing file overwritten in Google Drive."
} else {
    # Upload new file
    $fileMetadata = New-Object Google.Apis.Drive.v3.Data.File
    $fileMetadata.Name = $fileName
    $fileMetadata.Parents = [System.Collections.Generic.List[string]]::new()
    $fileMetadata.Parents.Add($folderId)

    $fileStream = [System.IO.File]::Open($CSVExportPath, 'Open')
    $createRequest = $service.Files.Create($fileMetadata, $fileStream, "text/csv")
    $createRequest.Fields = "id"
    $createRequest.Upload()
    $fileStream.Close()
    Write-Host "🚀 New file uploaded successfully to Google Drive."
}